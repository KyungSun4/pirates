function doPolygonsIntersect(a,b){var d,e,f,g,h,i,j,k,c=[a,b];for(g=0;g<c.length;g++){var l=c[g];for(h=0;h<l.length;h++){var m=(h+1)%l.length,n=l[h],o=l[m],p={x:o.y-n.y,y:n.x-o.x};for(d=e=void 0,i=0;i<a.length;i++)f=p.x*a[i].x+p.y*a[i].y,(void 0==d||f<d)&&(d=f),(void 0==e||f>e)&&(e=f);for(j=k=void 0,i=0;i<b.length;i++)f=p.x*b[i].x+p.y*b[i].y,(void 0==j||f<j)&&(j=f),(void 0==k||f>k)&&(k=f);if(e<j||k<d)return!1}}return!0}console.log("hello wordl");var express=require("express"),app=express(),serv=require("http").Server(app),TO_RADIANS=Math.PI/180;app.get("/",function(a,b){b.sendFile(__dirname+"/client/mobile.html")}),app.use("/client",express.static(__dirname+"/client")),serv.listen(2e3),console.log("MISSION GO");var socketlist={},mapw=1e4,maph=1e4,ctypes=[{range:1e3,btype:1,type:0,reload:19},{range:1e3,btype:0,type:1,reload:30},{range:1e3,btype:0,type:2,reload:20},{range:1e3,btype:0,type:3,reload:20},{range:1e3,btype:1,type:3,reload:20},{range:1e3,btype:1,type:4,reload:10}],btypes=[{width:8,height:8,damage:10,speed:10},{width:12,height:4,damage:5,speed:20}],ptypes=[{reload:30,vel:20,rotdrag:1,maxrot:10,rotaccel:1,width:38,height:30,type:0,worth:10},{reload:30,vel:7,rotdrag:2,maxrot:10,rotaccel:2,width:40,height:30,type:1,worth:10}],types=[{type:0,width:50,height:44,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:0,dist:20,ang:0}]},{type:1,width:42,height:22,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:0,dist:14,ang:0}]},{type:2,width:74,height:34,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:2,dist:18,ang:0}]},{type:3,width:98,height:30,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:4,dist:26,ang:0}]},{type:4,width:88,height:30,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:0,dist:20,ang:0}]},{type:5,width:138,height:38,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:0,dist:20,ang:0}]},{type:6,width:122,height:46,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:2,dist:12,ang:90},{type:2,dist:12,ang:270}]},{type:7,width:156,height:62,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:1,dist:28,ang:45},{type:1,dist:28,ang:315},{type:1,dist:60,ang:160},{type:1,dist:60,ang:200}]},{type:8,width:49,height:17,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:0,dist:20,ang:0}]},{type:9,width:352,height:134,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:4,dist:102.4,ang:19},{type:4,dist:100,ang:348.5}]},{type:10,width:182,height:58,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:2,dist:45,ang:0},{type:2,dist:22.4,ang:63.4},{type:2,dist:22.4,ang:296.6},{type:2,dist:34,ang:140},{type:2,dist:34,ang:220},{type:2,dist:74.7,ang:164},{type:2,dist:74.7,ang:195}]},{type:11,width:238,height:76,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:4,dist:105,ang:16}]},{type:12,width:174,height:54,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:0,dist:20,ang:0}]},{type:13,width:198,height:46,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:5,dist:44,ang:0},{type:5,dist:22,ang:0},{type:5,dist:38,ang:180},{type:5,dist:58,ang:180},{type:0,dist:20,ang:53},{type:0,dist:20,ang:307},{type:0,dist:30.5,ang:153},{type:0,dist:30.5,ang:206.6}]},{type:14,width:170,height:42,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:5,dist:48,ang:0},{type:5,dist:44,ang:180},{type:0,dist:19,ang:66},{type:0,dist:19,ang:294}]},{type:15,width:152,height:42,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:4,dist:34,ang:0}]},{type:16,width:200,height:96,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:3,dist:0,ang:0}]},{type:17,width:142,height:66,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:0,dist:20,ang:0}]},{type:18,width:200,height:70,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:0,dist:20,ang:0}]},{type:19,width:284,height:54,mass:1,health:100,maxhealth:100,accel:2,drag:.2,maxSpd:10,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],reload:30,worth:10,frame:1,cannons:[{type:5,dist:49,ang:0},{type:5,dist:77,ang:0},{type:5,dist:59,ang:180},{type:5,dist:84,ang:180},{type:4,dist:43,ang:152},{type:4,dist:43,ang:208},{type:4,dist:30,ang:40.2},{type:4,dist:30,ang:319.8},{type:4,dist:20.4,ang:101.3},{type:4,dist:20.4,ang:258.7},{type:0,dist:18.9,ang:58},{type:0,dist:18.9,ang:302},{type:0,dist:22.6,ang:135},{type:0,dist:22.6,ang:225},{type:0,dist:54.4,ang:162.9},{type:0,dist:54.4,ang:197.1}]}],getRandomColor=function(){for(var a="0123456789ABCDEF",b="#",c=0;c<6;c++)b+=a[Math.floor(16*Math.random())];return console.log(b),b},buyplane=function(a,b){Player.list[a.playerid].money>=types[b].worth&&(plane=a.Plane(a.id,a.playerid),plane.reload=ptypes[b].reload,plane.vel=ptypes[b].vel,plane.rotdrag=ptypes[b].rotdrag,plane.maxrot=ptypes[b].maxrot,plane.rotaccel=ptypes[b].rotaccel,plane.width=ptypes[b].width,plane.height=ptypes[b].height,plane.type=ptypes[b].type,plane.worth=ptypes[b].worth,Player.list[a.playerid].money=Player.list[a.playerid].money-ptypes[b].worth,plane.x=a.x,plane.y=a.y)},changetype=function(a,b){a.type=types[b].type,a.width=types[b].width,a.height=types[b].height,a.mass=types[b].mass,a.health=types[b].health,a.maxhealth=types[b].maxhealth,a.accel=types[b].accel,a.drag=types[b].drag,a.maxSpd=types[b].maxSpd,a.rotaccel=types[b].rotaccel,a.rotdrag=types[b].rotdrag,a.maxrot=types[b].maxrot,a.handling=types[b].handling,a.points=types[b].points,a.reload=types[b].reload,a.worth=types[b].worth,a.frame=types[b].frame;for(var c in a.Cannon.list)delete a.Cannon.list[c];for(j=0;j<types[b].cannons.length;j++){var d=a.Cannon(a.id,a.playerid,types[b].cannons[j].dist,types[b].cannons[j].ang);d.type=types[b].cannons[j].type,d.btype=ctypes[d.type].btype,d.reload=ctypes[d.type].reload+Math.round(3*Math.random()),d.width=ctypes[d.type].width,d.height=ctypes[d.type].height,d.range=ctypes[d.type].range}},buytype=function(a,b){Player.list[a.playerid].money>=types[b].worth&&(changetype(a,b),Player.list[a.playerid].money=Player.list[a.playerid].money-types[b].worth)},Coin=function(a,b,c){var d={x:a,y:b,width:6,height:6,toRemove:!1,value:1,parentid:c,update:function(){d.points=[{x:this.x+d.width,y:this.y+d.height},{x:this.x+d.width,y:this.y-d.height},{x:this.x-d.width,y:this.y-d.height},{x:this.x-d.width,y:this.y+d.height}]}};return Coin.list[Math.random()]=d,d};Coin.list={},Coin.l=0;var Wake=function(a,b){var c={time:0,x:a,y:b};return Wake.list[Math.random()]=c,c};Wake.list={};var Bullet=function(a,b,c,d,e,f,g,h){var i={x:a,y:b,parentid:d,pvx:e,pvy:f,angle:c,width:btypes[g].width,height:btypes[g].height,damage:btypes[g].damage,speed:btypes[g].speed,range:h,id:""+Math.random(),toRemove:!1,time:0,type:g,points:[],update:function(){i.time++,i.speed*i.time>i.range&&(i.toRemove=!0),i.x+=i.speed*Math.cos(i.angle)+i.pvx,i.y+=i.speed*Math.sin(i.angle)+i.pvy,i.points=[{x:this.x+Math.cos(i.angle)*i.width,y:this.y+Math.sin(i.angle)*i.height},{x:this.x+Math.cos(i.angle)*i.width,y:this.y-Math.sin(i.angle)*i.height},{x:this.x-Math.cos(i.angle)*i.width,y:this.y-Math.sin(i.angle)*i.height},{x:this.x-Math.cos(i.angle)*i.width,y:this.y+Math.sin(i.angle)*i.height}]}};return Bullet.list[i.id]=i,i};Bullet.list={};var Player=function(a,b){var c={color:getRandomColor(),left:!1,right:!1,up:!1,down:!1,shooting:!1,mousex:0,mousey:0,controlx:0,controly:0,mobile:!1,name:b,id:a,money:100,death:!1,gstate:1,selected:0,winwidth:1e3,winheight:1e3,leaderid:a,update:function(){for(var a in c.Ship.list)ship=c.Ship.list[a],ship.leader&&(ship.left=c.left,ship.right=c.right,ship.up=c.up,ship.down=c.down,c.leaderid=ship.id,ship.controlx=c.controlx,ship.controly=c.controly,ship.mobile=c.mobile),ship.mousex=c.mousex,ship.mousey=c.mousey,ship.shooting=c.shooting},Ship:function(b,c){var d={x:-1e4,y:-1e4,width:50,height:44,angle:30,playerid:b,id:Math.random(),up:!1,left:!1,right:!1,down:!1,shooting:!1,mousex:0,mousey:0,mass:1,health:100,maxhealth:100,vel:0,velx:0,vely:0,accel:2,drag:.2,maxSpd:10,rotvel:0,rotaccel:1,rotdrag:1,maxrot:10,handling:10,points:[],shootime:0,reload:30,controlx:0,controly:0,mobile:!1,name:c,frame:1,time:0,worth:10,type:0,leader:!1,placed:!1,in:!1,reld:400,relangl:0,tox:0,toy:0,distangle:0,auto:0,update:function(){if(d.mass=d.width*d.height,d.controlx>1&&(d.controlx=1),d.controly>1&&(d.controly=1),d.controlx<-1&&(d.controlx=-1),d.controly<-1&&(d.controly=-1),d.leader)d.mobile?(d.controly>0?d.vel<d.maxSpd&&(d.vel+=d.accel*d.controly):d.vel>0&&(d.vel<d.drag?d.vel=0:d.vel-=d.drag),d.controly<0?d.vel>-d.maxSpd/4&&(d.vel-=d.accel/4*-d.controly):d.vel<0&&(d.vel<d.drag?d.vel=0:d.vel+=d.drag),d.controlx<0&&d.rotvel<d.maxrot&&0!==d.vel&&(d.rotvel+=d.rotaccel*-d.controlx),d.rotvel>0&&(d.controlx>=0||0==d.vel)&&(d.rotvel<d.rotdrag?d.rotvel=0:d.rotvel-=d.rotdrag),d.controlx>0&&d.rotvel>-d.maxrot&&(d.vel>.3||d.vel<-.3)&&(d.rotvel-=d.rotaccel*d.controlx),d.rotvel<0&&(d.controlx<=0||0==d.vel)&&(d.rotvel>-d.rotdrag?d.rotvel=0:d.rotvel+=d.rotdrag)):(d.up?d.vel<d.maxSpd&&(d.vel+=d.accel):d.vel>0&&(d.vel<d.drag?d.vel=0:d.vel-=d.drag),d.down?d.vel>-d.maxSpd/4&&(d.vel-=d.accel/4):d.vel<0&&(d.vel<d.drag?d.vel=0:d.vel+=d.drag),d.right&&d.rotvel<d.maxrot&&0!==d.vel&&(d.rotvel+=d.rotaccel),d.rotvel>0&&(0!=d.right&&0!=d.vel||(d.rotvel<d.rotdrag?d.rotvel=0:d.rotvel-=d.rotdrag)),d.left&&d.rotvel>-d.maxrot&&(d.vel>.3||d.vel<-.3)&&(d.rotvel-=d.rotaccel),d.rotvel<0&&(0!=d.left&&0!=d.vel||(d.rotvel>-d.rotdrag?d.rotvel=0:d.rotvel+=d.rotdrag)));else if(d.in){for(var a in Player.list[d.playerid].Ship.list)Player.list[d.playerid].Ship.list[a].leader&&(leader=Player.list[d.playerid].Ship.list[a]);for(d.tox=Math.cos(TO_RADIANS*d.relangl+TO_RADIANS*leader.angle)*d.reld+leader.x,d.toy=Math.sin(TO_RADIANS*d.relangl+TO_RADIANS*leader.angle)*d.reld+leader.y,d.distangle=Math.atan2(d.toy-d.y,d.tox-d.x)/TO_RADIANS;d.distangle<0;)d.distangle=d.distangle+360;for(;d.distangle>360;)d.distangle=d.distangle-360;for(;d.angle<0;)d.angle=d.angle+360;for(;d.angle>360;)d.angle=d.angle-360;var c=Math.sqrt(Math.pow(d.toy-d.y,2)+Math.pow(d.tox-d.x,2));d.x==d.tox&&d.y==d.toy||c>0&&(c<=Math.pow(d.vel,2)/d.drag/2+2?d.vel>=d.drag&&(d.vel=d.vel-d.drag):c>3*d.maxSpd&&d.vel<d.maxSpd&&(d.vel=d.vel+d.accel),c<3*d.maxSpd&&(d.vel>0&&(d.vel=d.vel-d.drag),d.vel<d.drag&&(d.vel=0)),d.vel>d.maxSpd&&(d.vel=d.maxSpd),d.vel>0?(d.angle-d.distangle+360)%360<180?(d.rotvel>d.distangle-d.angle&&(d.rotvel=d.distangle-d.angle),d.rotvel<d.maxrot&&(d.rotvel=d.rotvel+d.rotaccel)):(d.angle-d.distangle+360)%360>180?(d.rotvel>-(d.distangle-d.angle)&&(d.rotvel=d.distangle-d.angle),d.rotvel>-d.maxrot&&(d.rotvel=d.rotvel-d.rotaccel)):(d.rotvel>0||d.rotvel<0)&&(d.rotvel>=d.rotdrag?d.rotvel=d.rotvel-d.rotdrag:d.rotvel<=-d.rotdrag?d.rotvel=d.rotvel+d.rotdrag:Math.abs(d.rotvel)<d.rotdrag&&(d.rotvel=0)):(d.rotvel>0||d.rotvel<0)&&(d.rotvel>=d.rotdrag?d.rotvel=d.rotvel-d.rotdrag:d.rotvel<=-d.rotdrag?d.rotvel=d.rotvel+d.rotdrag:Math.abs(d.rotvel)<d.rotdrag&&(d.rotvel=0)),d.rotvel>d.maxrot&&(d.rotvel=d.maxrot),d.rotvel<-d.maxrot&&(d.rotvel=-d.maxrot),d.vel<d.maxSpd&&d.dist<d.maxSpd&&(d.x=d.tox,d.y=d.toy,d.vel=0))}d.points=[{x:d.x+d.width/2*Math.cos(TO_RADIANS*d.angle)- -d.height/2*Math.sin(d.angle*TO_RADIANS),y:d.y+d.width/2*Math.sin(TO_RADIANS*d.angle)+-d.height/2*Math.cos(d.angle*TO_RADIANS)},{x:d.x+d.width/2*Math.cos(TO_RADIANS*d.angle)-d.height/2*Math.sin(d.angle*TO_RADIANS),y:d.y+d.width/2*Math.sin(TO_RADIANS*d.angle)+d.height/2*Math.cos(d.angle*TO_RADIANS)},{x:d.x+-d.width/2*Math.cos(TO_RADIANS*d.angle)-d.height/2*Math.sin(d.angle*TO_RADIANS),y:d.y+-d.width/2*Math.sin(TO_RADIANS*d.angle)+d.height/2*Math.cos(d.angle*TO_RADIANS)},{x:d.x+-d.width/2*Math.cos(TO_RADIANS*d.angle)- -d.height/2*Math.sin(d.angle*TO_RADIANS),y:d.y+-d.width/2*Math.sin(TO_RADIANS*d.angle)+-d.height/2*Math.cos(d.angle*TO_RADIANS)}];for(var e=Math.floor(d.mass/6e3*d.vel),f=0;f<e;f++)Wake((d.points[3].x+d.points[2].x)/2+((Math.random()+Math.random())/2-.5)*d.height,(d.points[3].y+d.points[2].y)/2+((Math.random()+Math.random())/2-.5)*d.height);d.angle+=d.rotvel,d.velx=d.vel*Math.cos(d.angle*TO_RADIANS),d.vely=d.vel*Math.sin(d.angle*TO_RADIANS);for(var g in Player.list){player=Player.list[g];for(var a in player.Ship.list)if(player.Ship.list[a].id!==d.id){var h=player.Ship.list[a];if(doPolygonsIntersect(d.points,h.points)){var i=Math.atan2(h.y-d.y,h.x-d.x);d.velx=-(h.mass/d.mass)*Math.cos(i),d.vely=-(h.mass/d.mass)*Math.sin(i),d.vel=0}}}d.x>mapw-d.width/2&&(d.x=mapw-d.width/2),d.x<d.width/2&&(d.x=d.width/2),d.y>maph-d.width/2&&(d.y=maph-d.width/2),d.y<d.width/2&&(d.y=d.width/2),d.x+=d.velx,d.y+=d.vely;for(var a in Bullet.list)if(Bullet.list[a].parentid!==d.playerid){var j=Bullet.list[a];doPolygonsIntersect(d.points,j.points)&&(d.health-=j.damage,j.toRemove=!0)}for(var a in Coin.list){var k=Coin.list[a];k.parentid!==d.playerid&&doPolygonsIntersect(d.points,k.points)&&(Player.list[b].money+=k.value,k.toRemove=!0)}d.vel>d.maxSpd&&(d.vel=d.maxSpd),d.vel<-d.maxSpd/4&&(d.vel=-d.maxSpd/4),d.time++,d.time>=40*(d.maxSpd-d.vel+.1)&&0!=d.vel&&(d.frame++,4==d.frame&&(d.frame=1),d.time=0),d.time>=40*(d.maxSpd/4+d.vel+.1)&&0!=d.vel&&(d.frame--,0==d.frame&&(d.frame=3),d.time=0);for(var a in Player.list[d.playerid].Ship.list[d.id].Cannon.list){var l=Player.list[d.playerid].Ship.list[d.id].Cannon.list[a];l.update()}for(var a in Player.list[d.playerid].Ship.list[d.id].Plane.list){var m=Player.list[d.playerid].Ship.list[d.id].Plane.list[a];if(m.update(),m.health<=0){for(a=0;a<Math.round(m.worth);a++){var n=Coin(m.x+(Math.random()-.5)*m.width,m.y+(Math.random()-.5)*m.width,m.playerid);n.update()}delete Player.list[d.playerid].Ship.list[d.id].Plane.list[m.id]}}},Cannon:function(b,c,d,e){var f={x:0,y:0,id:Math.random(),shipid:b,playerid:c,shootime:0,reload:30,dist:d,ang:e,angle:0,type:0,rela:0,atx:0,aty:0,btype:0,range:10,shootBullet:function(a,b,c,d,e,f,g,h){var i=Bullet(a,b,c,d,e,f,g,h);i.update()},update:function(){if(parentship=Player.list[f.playerid].Ship.list[f.shipid],f.x=parentship.x+Math.cos((parentship.angle+f.ang)*TO_RADIANS)*f.dist,f.y=parentship.y+Math.sin((parentship.angle+f.ang)*TO_RADIANS)*f.dist,f.shootime>0&&f.shootime--,f.shootime<0&&(f.shootime=0),f.shootime<=0){if(parentship.shooting&&0==parentship.auto&&(f.angle=Math.atan2(parentship.mousey-f.y,parentship.mousex-f.x),f.rela=f.angle-parentship.angle*TO_RADIANS,f.shootBullet(f.x,f.y,Math.atan2(parentship.mousey-f.y,parentship.mousex-f.x),f.playerid,0,0,f.btype,f.range),f.shootime=f.reload),1==parentship.auto){var a=1e6;for(var b in Player.list)for(var c in Player.list[b].Ship.list){var d=Player.list[b].Ship.list[c];d.playerid!==f.playerid&&Math.sqrt(Math.pow(f.x-d.x,2)+Math.pow(f.y-d.y,2))<a&&(f.atx=d.x,f.aty=d.y,a=Math.sqrt(Math.pow(f.x-d.x,2)+Math.pow(f.y-d.y,2)))}f.angle=Math.atan2(f.aty-f.y,f.atx-f.x),f.rela=f.angle-parentship.angle*TO_RADIANS,a<1.5*f.range&&f.shootBullet(f.x,f.y,Math.atan2(f.aty-f.y,f.atx-f.x),f.playerid,0,0,f.btype,f.range),f.shootime=f.reload}if(2==parentship.auto){var e=0;for(var b in Player.list)for(var c in Player.list[b].Ship.list){var d=Player.list[b].Ship.list[c];d.playerid!==f.playerid&&d.health>e&&Math.sqrt(Math.pow(f.x-d.x,2)+Math.pow(f.y-d.y,2))<=f.range&&(f.atx=d.x,f.aty=d.y)}f.angle=Math.atan2(f.aty-f.y,f.atx-f.x),f.rela=f.angle-parentship.angle*TO_RADIANS,f.shootBullet(f.x,f.y,Math.atan2(f.aty-f.y,f.atx-f.x),f.playerid,0,0,f.btype,f.range),f.shootime=f.reload}if(3==parentship.auto){var e=1e6;for(var b in Player.list)for(var c in Player.list[b].Ship.list){var d=Player.list[b].Ship.list[c];d.playerid!==f.playerid&&d.health<e&&Math.sqrt(Math.pow(f.x-d.x,2)+Math.pow(f.y-d.y,2))<=f.range&&(f.atx=d.x,f.aty=d.y)}f.angle=Math.atan2(f.aty-f.y,f.atx-f.x),f.rela=f.angle-parentship.angle*TO_RADIANS,f.shootBullet(f.x,f.y,Math.atan2(f.aty-f.y,f.atx-f.x),f.playerid,0,0,f.btype,f.range),f.shootime=f.reload}}f.angle=parentship.angle*TO_RADIANS+f.rela}};return Player.list[a].Ship.list[f.shipid].Cannon.list[f.id]=f,f},Plane:function(b,c){var d={id:Math.random(),shipid:b,playerid:c,shootime:0,reload:30,angle:0,health:30,maxhealth:30,rela:0,vel:20,rotvel:0,angle:0,distangle:0,rotdrag:1,maxrot:10,rotaccel:1,width:38,height:30,type:0,worth:10,frame:1,time:0,x:0,y:0,atx:0,aty:0,btype:0,range:1e3,farea:5e3,shootBullet:function(a,b,c,d,e,f,g,h){var i=Bullet(a,b,c,d,e,f,g,h);i.update()},update:function(){parentship=Player.list[d.playerid].Ship.list[d.shipid],parentship.mousex?(d.tox=parentship.mousex,d.toy=parentship.mousey):(d.tox=parentship.x,d.toy=parentship.y);var a=0;if(1==parentship.auto){var b=1e6;for(var c in Player.list)for(var e in Player.list[c].Ship.list){var f=Player.list[c].Ship.list[e];f.playerid!==d.playerid&&Math.sqrt(Math.pow(d.x-f.x,2)+Math.pow(d.y-f.y,2))<b&&Math.sqrt(Math.pow(d.x-f.x,2)+Math.pow(d.y-f.y,2))<2*d.farea&&(d.atx=f.x,d.aty=f.y,a++,b=Math.sqrt(Math.pow(d.x-f.x,2)+Math.pow(d.y-f.y,2)))}d.tox=d.atx,d.toy=d.aty}if(2==parentship.auto){var g=0;for(var c in Player.list)for(var e in Player.list[c].Ship.list){var f=Player.list[c].Ship.list[e];f.playerid!==d.playerid&&f.health>g&&Math.sqrt(Math.pow(d.x-f.x,2)+Math.pow(d.y-f.y,2))<=d.farea&&(d.atx=f.x,d.aty=f.y,a++)}d.tox=d.atx,d.toy=d.aty}if(3==parentship.auto){var g=1e6;for(var c in Player.list)for(var e in Player.list[c].Ship.list){var f=Player.list[c].Ship.list[e];f.playerid!==d.playerid&&f.health<g&&Math.sqrt(Math.pow(d.x-f.x,2)+Math.pow(d.y-f.y,2))<=d.farea&&(d.atx=f.x,d.aty=f.y,a++)}d.tox=d.atx,d.toy=d.aty}for(0==a&&parentship.auto>0&&(d.tox=parentship.x,d.toy=parentship.y),d.distangle=Math.atan2(d.toy-d.y,d.tox-d.x)/TO_RADIANS;d.distangle<0;)d.distangle=d.distangle+360;for(;d.distangle>360;)d.distangle=d.distangle-360;for(;d.angle<0;)d.angle=d.angle+360;for(;d.angle>360;)d.angle=d.angle-360;Math.sqrt(Math.pow(d.toy-d.y,2)+Math.pow(d.tox-d.x,2));d.vel>0?(d.angle-d.distangle+360)%360<180?(d.rotvel>d.distangle-d.angle&&(d.rotvel=d.distangle-d.angle),d.rotvel<d.maxrot&&(d.rotvel=d.rotvel+d.rotaccel)):(d.angle-d.distangle+360)%360>180?(d.rotvel>-(d.distangle-d.angle)&&(d.rotvel=d.distangle-d.angle),d.rotvel>-d.maxrot&&(d.rotvel=d.rotvel-d.rotaccel)):(d.rotvel>0||d.rotvel<0)&&(d.rotvel>=d.rotdrag?d.rotvel=d.rotvel-d.rotdrag:d.rotvel<=-d.rotdrag?d.rotvel=d.rotvel+d.rotdrag:Math.abs(d.rotvel)<d.rotdrag&&(d.rotvel=0)):(d.rotvel>0||d.rotvel<0)&&(d.rotvel>=d.rotdrag?d.rotvel=d.rotvel-d.rotdrag:d.rotvel<=-d.rotdrag?d.rotvel=d.rotvel+d.rotdrag:Math.abs(d.rotvel)<d.rotdrag&&(d.rotvel=0)),d.rotvel>d.maxrot&&(d.rotvel=d.maxrot),d.rotvel<-d.maxrot&&(d.rotvel=-d.maxrot),d.shootime>0&&d.shootime--,d.shootime<0&&(d.shootime=0),d.distangle-d.angle<7&&d.distangle-d.angle>-7&&d.shootime<=0&&(parentship.shooting&&0==parentship.auto&&(d.shootBullet(d.x,d.y,d.angle*TO_RADIANS,d.playerid,0,0,d.btype,d.range),d.shootime=d.reload),1!=parentship.auto&&2!=parentship.auto&&3!=parentship.auto||0!=a&&(d.shootBullet(d.x,d.y,d.angle*TO_RADIANS,d.playerid,0,0,d.btype,d.range),d.shootime=d.reload)),d.points=[{x:this.x+Math.cos(TO_RADIANS*d.angle)*d.width/2,y:this.y+Math.sin(TO_RADIANS*d.angle)*d.height/2},{x:this.x+Math.cos(TO_RADIANS*d.angle)*d.width/2,y:this.y-Math.sin(TO_RADIANS*d.angle)*d.height/2},{x:this.x-Math.cos(TO_RADIANS*d.angle)*d.width/2,y:this.y-Math.sin(TO_RADIANS*d.angle)*d.height/2},{x:this.x-Math.cos(TO_RADIANS*d.angle)*d.width/2,y:this.y+Math.sin(TO_RADIANS*d.angle)*d.height/2}],d.angle+=d.rotvel,d.velx=d.vel*Math.cos(d.angle*TO_RADIANS),d.vely=d.vel*Math.sin(d.angle*TO_RADIANS),d.x+=d.velx,d.y+=d.vely;for(var c in Bullet.list)if(Bullet.list[c].parentid!==d.playerid){var i=Bullet.list[c];doPolygonsIntersect(d.points,i.points)&&(d.health-=i.damage,i.toRemove=!0)}d.time++,1==d.type&&(d.time>1&&(d.frame++,d.time=0),d.frame>2&&(d.frame=1)),0==d.type&&(d.time>1&&(d.frame++,d.time=0),d.frame>3&&(d.frame=1))}};return Player.list[a].Ship.list[d.shipid].Plane.list[d.id]=d,d}};return Player.list[a].Ship.list[d.id]=d,Player.list[a].Ship.list[d.id].Cannon.list={},Player.list[a].Ship.list[d.id].Plane.list={},d}};return Player.list[a]=c,Player.list[a].Ship.list={},console.log("list"+c.Ship.list),c};Player.list={},Player.onconnect=function(a,b){var c=Player(a.id,b),d=c.Ship(c.id,c.name);d.Cannon(d.id,c.id,30,0);changetype(d,0),d.leader=!0,c.selected=d.id,console.log(c.selected),d.x=Math.random()*mapw,d.y=Math.random()*maph,d.placed=!0,d.in=!0,a.start=!0,a.on("resize",function(a){c.winwidth=a.width,c.winheight=a.height}),a.on("select",function(a){c.selected=a}),a.on("button",function(a){var b=c.Ship.list[c.selected];if(7==a.number&&(b.auto=0),8==a.number&&(b.auto=1),9==a.number&&(b.auto=2),10==a.number&&(b.auto=3),13==b.type&&(1==a.number&&buytype(b,19),2==a.number,3==a.number),5==b.type&&(1==a.number&&buytype(b,12),2==a.number,3==a.number),4==b.type&&(1==a.number&&buytype(b,5),2==a.number,3==a.number),7==b.type&&(1==a.number&&buytype(b,16),2==a.number&&buytype(b,18),3==a.number),6==b.type&&(1==a.number&&buytype(b,7),2==a.number&&buytype(b,10),3==a.number),2==b.type&&(1==a.number&&buytype(b,6),2==a.number,3==a.number),9==b.type&&(1==a.number,2==a.number&&buyplane(b,0),3==a.number&&buyplane(b,1)),14==b.type&&(1==a.number&&buytype(b,13),2==a.number&&buyplane(b,1),3==a.number),11==b.type&&(1==a.number&&buytype(b,9),2==a.number&&buyplane(b,0),3==a.number&&buyplane(b,1)),15==b.type&&(1==a.number&&buytype(b,11),2==a.number&&buytype(b,14),3==a.number&&buyplane(b,1)),3==b.type&&(1==a.number&&buytype(b,15),2==a.number,3==a.number),1==b.type&&(1==a.number&&buytype(b,3),2==a.number,3==a.number),0==b.type&&(1==a.number&&buytype(b,1),2==a.number&&buytype(b,2),3==a.number&&buytype(b,4)),4==a.number&&c.money>=10){c.gstate=2;var d=c.Ship(c.id,c.name);d.Cannon(d.id,c.id,30,0);changetype(d,0),c.money=c.money-10,d.leader=!1}if(5==a.number){for(var f in c.Ship.list)(c.Ship.list[f].leader=!0)&&(c.Ship.list[f].leader=!1);b.leader=!0}6==a.number&&0==b.leader&&(b.placed=!1,c.gstate=2)}),a.on("place",function(a){for(var b in c.Ship.list)if(shipp=c.Ship.list[b],0==shipp.placed){c.gstate=1,shipp.placed=!0,shipp.reld=a.d,shipp.relangl=a.angle;for(var b in Player.list[shipp.playerid].Ship.list)Player.list[shipp.playerid].Ship.list[b].leader&&(leader=Player.list[shipp.playerid].Ship.list[b]);shipp.in||(shipp.x=Math.cos(TO_RADIANS*shipp.relangl+TO_RADIANS*leader.angle)*shipp.reld+leader.x,shipp.y=Math.sin(TO_RADIANS*shipp.relangl+TO_RADIANS*leader.angle)*shipp.reld+leader.y,shipp.in=!0)}}),a.on("keypress",function(a){"left"===a.inputId&&(c.left=a.state),"right"===a.inputId&&(c.right=a.state),"up"===a.inputId&&(c.up=a.state),"down"===a.inputId&&(c.down=a.state),"shooting"===a.inputId&&(c.shooting=a.state,c.mousex=a.x,c.mousey=a.y),"control"===a.inputId&&(c.controlx=a.x,c.controly=a.y,c.mobile=!0)})},Player.onDisconnect=function(a){delete Player.list[a.id]};var io=require("socket.io")(serv,{});io.sockets.on("connection",function(a){a.id=Math.random(),a.start=!1,a.emit("id",a.id),a.on("start",function(b){Player.onconnect(a,b),console.log(b+" started with id "+a.id)}),socketlist[a.id]=a,console.log("socket connection"+a.id),a.on("disconnect",function(){delete socketlist[a.id],Player.onDisconnect(a),console.log(a.id+"disconnected")})});var getcannon=function(a){var b=[];for(var c in a)b.push({x:a[c].x,y:a[c].y,angle:a[c].angle,type:a[c].type});return b},getplane=function(a){var b=[];for(var c in a)b.push({x:a[c].x,y:a[c].y,angle:a[c].angle,type:a[c].type,width:a[c].width,height:a[c].height,frame:a[c].frame,health:a[c].health,maxhealth:a[c].maxhealth});return b};Player.update=function(){var a=[];for(var b in Player.list){var c=Player.list[b];c.update();for(var d in c.Ship.list){var e=c.Ship.list[d];if(e.update(e.Cannon.list[d]),a.push({x:e.x,y:e.y,width:e.width,height:e.height,angle:e.angle,speed:e.vel,id:e.id,playerid:e.playerid,leader:e.leader,name:e.name,death:c.death,health:e.health,maxhealth:e.maxhealth,frame:e.frame,money:c.money,type:e.type,seltype:c.Ship.list[c.selected].type,gstate:c.gstate,cannons:getcannon(e.Cannon.list),planes:getplane(e.Plane.list),color:c.color}),e.health<=0){var f=0;for(var g in c.Ship.list)f++;if(1==f){for(d=0;d<Math.round(c.money);d++){var h=Coin(e.x+(Math.random()-.5)*e.width,e.y+(Math.random()-.5)*e.width,e.playerid);h.update()}delete Player.list[c.id]}for(d=0;d<Math.round(e.worth);d++){var h=Coin(e.x+(Math.random()-.5)*e.width,e.y+(Math.random()-.5)*e.width,e.playerid);h.update()}if(1==e.leader&&f>=1){var i=0;for(var j in c.Ship.list)0==i&&(c.Ship.list[j].leader=!0,e.leader=!1),c.Ship.list[j]!=e&&i++;if(0==i){var k=!0,l=socketlist[c.id];l.emit("dead",k),c.death=!0}}if(e.id==c.selected&&!c.death)for(var b in c.Ship.list)c.Ship.list[b].leader&&(c.selected=c.Ship.list[b].id);delete c.Ship.list[e.id]}}}return a},Bullet.update=function(){var a=[];for(var b in Bullet.list){var c=Bullet.list[b];c.toRemove&&delete Bullet.list[b],c.update(),a.push({x:c.x,y:c.y,width:c.width,height:c.height,angle:c.angle,type:c.type})}return a},Wake.update=function(){var a=[];for(var b in Wake.list){var c=Wake.list[b];c.time>20&&delete Wake.list[b],a.push({x:c.x,y:c.y,time:c.time}),c.time=c.time+10*Math.random()}return a},Coin.update=function(){Coin.l=0;var a=[];for(var b in Coin.list){var c=Coin.list[b];c.toRemove&&delete Coin.list[b],c.update(),a.push({x:Math.round(10*c.x)/10,y:Math.round(10*c.y)/10}),Coin.l++}return a},setInterval(function(){if(Coin.l<1e3){var a=Coin(Math.random()*mapw,Math.random()*maph,0);a.update()}var b={bullet:Bullet.update(),ship:Player.update(),coin:Coin.update(),wake:Wake.update()};for(var c in socketlist){var d=socketlist[c],e={bullet:[],ship:[],coin:[],wake:[]};if(d.start){for(var f=Player.list[d.id].Ship.list[Player.list[d.id].leaderid],g=1.2*(Player.list[d.id].winwidth/2),h=1.2*(Player.list[d.id].winheight/2),i=0;i<b.bullet.length;i++)b.bullet[i].x>f.x+g||b.bullet[i].x<f.x-g||b.bullet[i].y>f.y+h||b.bullet[i].y<f.y-h||e.bullet.push(b.bullet[i]);e.ship=b.ship;for(var i=0;i<b.wake.length;i++)b.wake[i].x>f.x+g||b.wake[i].x<f.x-g||b.wake[i].y>f.y+h||b.wake[i].y<f.y-h||e.wake.push(b.wake[i]);for(var i=0;i<b.coin.length;i++)b.coin[i].x>f.x+g||b.coin[i].x<f.x-g||b.coin[i].y>f.y+h||b.coin[i].y<f.y-h||e.coin.push(b.coin[i]);d.emit("newPoisitions",e)}}},25);